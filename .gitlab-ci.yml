stages:
  - build
  - deploy
  - inspect
  - clean

build_image:
  stage: build
  script:
    - docker build -t tcn.re/inspectr/inspectr .
    - docker push tcn.re/inspectr/inspectr
  tags:
    - shell

pip_register:
  stage: deploy
  script:
    - python setup.py register -r teonite sdist upload -r teonite
  tags:
    - shell

metainspect:
  stage: inspect
  script:
    - docker run -v $(pwd):/code -v /home/gitlab-runner/inspectr_connector_docker.json:/root/.inspectr_connector.json tcn.re/inspectr/inspectr
  tags:
    - shell

cleanup:
  stage: clean
  script:
    - docker run -v $(pwd):/code tcn.re/inspectr/inspectr find /code -user root -exec rm -rf "{}" ';' || true
  tags:
    - shell
  when: always
